# render.yaml
# This file tells Render how to deploy your multi-service application.

services:
  # 1. The PostgreSQL Database
  - type: postgres
    name: axion-flow-db
    plan: free # Use the free tier for the database
    # Render will automatically handle the database URL for you

  # 2. The Backend API Service
  - type: web
    name: axion-flow-backend
    env: docker
    plan: free # Use the free tier for the web service
    # Tell Render where to find the Dockerfile for this service
    dockerfilePath: ./backend-api/Dockerfile
    # ADDED: Command to run database migrations before starting the server.
    # This is crucial for setting up your database schema on every deploy.
    buildCommand: "cd backend-api && npx prisma migrate deploy"
    # Define the environment variables the backend needs
    envVars:
      - key: DATABASE_URL
        # This special value tells Render to use the connection string from the database service above
        fromDatabase:
          name: axion-flow-db
          property: connectionString
      # ADDED: The internal URL for the AI service, so the backend can communicate with it.
      - key: AI_SERVICE_URL
        fromService:
          type: web
          name: axion-flow-ai-service
          property: url # Render automatically provides the internal URL
      # Pull secrets from a "Secret Group" you will create in the Render UI
      - fromGroup: axion-flow-secrets

  # 3. The AI Service
  - type: web
    name: axion-flow-ai-service
    env: docker
    plan: free
    dockerfilePath: ./ai-service/Dockerfile

  # 4. The Frontend Service (if deploying on Render)
  # NOTE: If you are deploying the frontend to Vercel, you should DELETE this section.
  - type: web
    name: axion-flow-frontend
    env: docker
    plan: free
    dockerfilePath: ./frontend-dashboard/Dockerfile
    envVars:
      # Tell the frontend the public URL of the backend service
      - key: VITE_API_URL
        # This special value gets the public URL of the backend service
        fromService:
          type: web
          name: axion-flow-backend
          property: url